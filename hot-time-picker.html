<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">

<!--
`hot-time-picker`
Minimal date picker

TODO:
* Make "required' actually work
* Make sure value is only ever set if all fields are actually set
* Add visual input that the field is actually set
* Make sure AMPM start as "empty", with empty option available

* Turn value=... hack into its own module

@demo demo/index.html
-->

<dom-module id="hot-time-picker">
  <template>
    <style>
      :host {
        display: block;
        margin-top: 20px;
        margin-bottom: 5px;
      }

      .container {
        @apply(--layout-flex-auto);
        @apply(--layout-relative);

        width: 100%;
        max-width: 100%;
      }

      label {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        width: 100%;
        font: inherit;
        color: var(--hot-time-picker-label-color, --secondary-text-color);
        -webkit-transition: -webkit-transform 0.25s, width 0.25s;
        transition: transform 0.25s, width 0.25s;
        -webkit-transform-origin: left top;
        transform-origin: left top;

        -webkit-transform: translateY(-25%) scale(0.75);
        transform: translateY(-25%) scale(0.75);
        width: 133%;

        @apply(--paper-font-common-nowrap);
        @apply(--paper-font-subhead);
      }

      .hour, .ampm, .minute {
        display: inline-block;
      }
      .hour {
        width: 3em;
      }
      .minute {
        width: 3em;
      }
      .ampm {
        width: 4em;
      }

    </style>

    <div class="container">
      <label>{{label}}</label>
      <paper-input id="hour" maxlength="2" class="hour" value="{{hour}}" name="hour" label="Hr" allowed-pattern="\d" pattern="^\d\d?$" error-message="Invalid!"></paper-input>


      <paper-input id="minute" id="ampm" maxlength="2" class="minute" value="{{minute}}" label="Min" pattern="^\d\d\d\d$" error-message="Invalid!"></paper-input>

      <paper-dropdown-menu id="ampm" value="[[ampm]]" class="ampm" name="ampm">
        <paper-listbox class="dropdown-content" selected="{{ampm}}" attr-for-selected="value">
          <paper-item label="" value="">Pick</paper-item>
          <paper-item value="am">AM</paper-item>
          <paper-item value="pm">PM</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>

    </container>

  </template>

  <script>
    Polymer({

      is: 'hot-time-picker',

      properties: {

        hour: {
          type: String,
        },

        minute: {
          type: String,
        },


        ampm: {
          type: String,
        },

        forceInvalid: {
          type: Boolean,
          default: false,
        },

      },

      behaviors: [
        Polymer.IronFormElementBehavior
      ],

      observers: [
        '_valueChanged(value)',
        '_timeChanged(hour,minute,ampm)',
      ],

      _oneFieldSet: function(){
        return !!( this.$.hour.value || this.$.minute.value || this.$.ampm.value );
      },

      ready: function(){

        var el = this;

        this.$.minute.inputElement.validate = function(){

          // Force to be invalid, element-wide
          if( el.forceInvalid ){
            this.invalid = true;
            return !this.invalid;
          }

          // Value is empty: invalid if main element is required or one field
          // is set
          if( !this.value || this.value == '' ){
            this.invalid = !!el.required || el._oneFieldSet();
            return !this.invalid;
          }

          var minute = this.value;

          if( minute < 0 || minute > 59 ){
            this.invalid = true;
          } else {
            this.invalid = false;
          }

          return !this.invalid;
        };


        this.$.ampm.validate = function(){

          // Force to be invalid, element-wide
          if( el.forceInvalid ){
            this.invalid = true;
            return !this.invalid;
          }

          // Value is empty: invalid if main element is required or one field
          // is set
          if( !this.value || this.value == '' ){
            this.invalid = !!el.required || el._oneFieldSet();
            return !this.invalid;
          }

          var ampm = this.value;

          // 12:10AM is nonsense, it must be 00:10AM
          if( ampm == 'am' && el.hour == 12 ){
            this.invalid = true;
            return !this.invalid;
          }

          // 00:10PM is nonsense, it must be 12:10PM
          if( ampm == 'pm' && el.hour == 0 ){
            this.invalid = true;
            return !this.invalid;
          }

          this.invalid = false;
          return !this.invalid;

        },

        this.$.hour.inputElement.validate = function(){

          // Force to be invalid, element-wide
          if( el.forceInvalid ){
            this.invalid = true;
            return !this.invalid;
          }

          // Value is empty: invalid if main element is required or one field
          // is set
          if( !this.value || this.value == '' ){
            this.invalid = !!el.required || el._oneFieldSet();
            return !this.invalid;
          }

          var hour = this.value;

          // Out of range in all cases
          if( hour < 0 || hour > 12 ){
            this.invalid = true;
            return !this.invalid;
          };

          // 12:10AM is nonsense, it must be 00:10AM
          if( el.ampm == 'am' && hour == 12 ){
            this.invalid = true;
            return !this.invalid;
          }

          // 00:10PM is nonsense, it must be 12:10PM
          if( el.ampm == 'pm' && hour == 0 ){
            this.invalid = true;
            return !this.invalid;
          }

          this.invalid = false;
          return !this.invalid;

        }
      },

      _pad: function(v){
        return String( v ).length  == 1  ?  "0" + v : v;

      },

      _timeChanged: function(){

        if( !this.hour || !this.minute || !this.ampm ){
          this._protectHourMinuteAmpm = true;
          this.value = '';
          this._protectHourMinuteAmpm = false;

          // async() is used because when user changes selection in paper-listbox,
          // paper-dropdown-menu (which is this.$.month) gets notified later.
          //this.validate();
          this.async( function(){ this.validate(); } );
          return;
        }


        var formattedHour = ( this.ampm == 'pm' && Number( this.hour ) < 12 ) ? String( Number( this.hour ) + 12 ) : this.hour;

        if( this.ampm == 'am' && this.hour == 0 ) this.$.hour.label = 'Midnight';
        else if( this.ampm == 'pm' && this.hour == 12 ) this.$.hour.label = 'Midday';
        else this.$.hour.label = 'Hr';

        this._protectHourMinuteAmpm = true;
        this.value = this._pad(formattedHour) + ":" + this._pad(this.minute);
        this._protectHourMinuteAmpm = false;

        // async() is used because when user changes selection in paper-listbox,
        // paper-dropdown-menu (which is this.$.month) gets notified later.
        //this.validate();
        this.async( function(){ this.validate(); } );

      },

      _valueChanged: function( v ){
        var m;

        // FIXME: Is this the way to go?
        if( ! this._protectHourMinuteAmpm ){

          if( ! v ) {
            this.minute = '';
            this.hour = '';
            this.ampm = '';
            return;
          }

          if( m = v.match(/^(\d{2}):(\d{2})$/m) ){



            this.minute = m[ 2 ];
            this.hour = this._pad( Number( m[ 1 ] ) );

            if( this.hour > 12 ){
              this.hour = this._pad( this.hour - 12 );
              this.ampm = 'pm';
            } else if( this.hour == 12 ){
              this.ampm = 'pm';
            } else {
              this.ampm = 'am';
            }
          }
        }
      },


      /*
       * Validate function; validation is TOTALLY delegated to the
       * sub-elements. They will do all of work of checking if they should be
       * set (if the parent is required, or if at least ONE sibling is set)
      */
      validate: function(){

        this.$.hour.validate();
        this.$.minute.validate();
        this.$.ampm.validate();

        // If MAIN element is required and it's not set, labelExtra is forced to "not set"
        // and it returns "false"
        if( this.required && ! this.value ){
          //this._labelExtra=this.valueNotSetConfirmation;
          this.invalid = true;
          return false;
        }

        // It's set as invalid if any one of the fields is invalid
        this.invalid = this.$.hour.invalid || this.$.minute.invalid || this.$.ampm.invalid;
        return !this.invalid;
      }


    });
  </script>
</dom-module>
